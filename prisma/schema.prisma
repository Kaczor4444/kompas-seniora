generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Placowka {
  id                Int                @id @default(autoincrement())
  nazwa             String
  typ_placowki      String
  prowadzacy        String?
  ulica             String?
  miejscowosc       String
  kod_pocztowy      String?
  gmina             String?
  powiat            String
  wojewodztwo       String
  telefon           String?
  email             String?
  www               String?
  liczba_miejsc     Int?
  miejsca_za_zyciem Int?     // Miejsca z programu "Za życiem" - część z liczba_miejsc (tylko ŚDS)
  profil_opieki     String?
  koszt_pobytu      Float?
  data_aktualizacji DateTime?
  latitude          Float?
  longitude         Float?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  verified          Boolean            @default(false)
  data_weryfikacji  DateTime?
  data_zrodla_cena  DateTime?
  data_zrodla_dane  DateTime?
  notatki           String?
  zrodlo_cena       String?
  zrodlo_dane       String?
  analytics         PlacowkaAnalytics?
  events            PlacowkaEvent[]
  snapshots         PlacowkaSnapshot[]
  ceny              PlacowkaCena[]     @relation("PlacowkaCeny")

  @@index([powiat])
  @@index([wojewodztwo])
  @@index([typ_placowki])
}

model TerytLocation {
  id               Int     @id @default(autoincrement())
  nazwa            String
  nazwa_normalized String
  typ              String
  gmina            String?
  powiat           String
  wojewodztwo      String

  @@index([nazwa_normalized])
  @@index([powiat])
  @@index([wojewodztwo])
}

model SharedList {
  id      Int      @id @default(autoincrement())
  token   String   @unique
  ids     String
  created DateTime @default(now())
  views   Int      @default(0)

  @@index([token])
  @@index([created])
}

model PlacowkaAnalytics {
  id             Int       @id @default(autoincrement())
  placowkaId     Int       @unique
  totalViews     Int       @default(0)
  uniqueVisitors Int       @default(0)
  phoneClicks    Int       @default(0)
  emailClicks    Int       @default(0)
  websiteClicks  Int       @default(0)
  favoritesCount Int       @default(0)
  comparesCount  Int       @default(0)
  sharesCount    Int       @default(0)
  lastViewed     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  placowka       Placowka  @relation(fields: [placowkaId], references: [id], onDelete: Cascade)

  @@index([placowkaId])
  @@index([totalViews])
  @@index([phoneClicks])
  @@index([lastViewed])
}

model PlacowkaEvent {
  id         Int      @id @default(autoincrement())
  placowkaId Int
  eventType  String
  userAgent  String?
  ipAddress  String?
  referer    String?
  metadata   Json?
  timestamp  DateTime @default(now())
  placowka   Placowka @relation(fields: [placowkaId], references: [id], onDelete: Cascade)

  @@index([placowkaId])
  @@index([eventType])
  @@index([timestamp])
  @@index([placowkaId, eventType])
  @@index([placowkaId, timestamp])
}

model MopsContact {
  id           Int       @id @default(autoincrement())
  city         String    @unique
  cityDisplay  String
  name         String
  phone        String
  email        String?
  address      String
  website      String?
  wojewodztwo  String
  verified     Boolean   @default(false)
  lastVerified DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([city])
  @@index([wojewodztwo])
  @@index([verified])
}

model PlacowkaSnapshot {
  id            Int      @id @default(autoincrement())
  placowkaId    Int
  rok           Int
  nazwa         String
  typ_placowki  String
  miejscowosc   String
  powiat        String
  wojewodztwo   String
  koszt_pobytu  Float?
  liczba_miejsc Int?
  profil_opieki String?
  status        String   @default("aktywna")
  createdAt     DateTime @default(now())
  placowka      Placowka @relation(fields: [placowkaId], references: [id], onDelete: Cascade)

  @@unique([placowkaId, rok])
  @@index([placowkaId])
  @@index([rok])
  @@index([wojewodztwo, rok])
}

model WojewodztwoStats {
  id               Int      @id @default(autoincrement())
  wojewodztwo      String
  rok              Int
  liczba_dps       Int
  liczba_sds       Int
  total_placowek   Int
  total_miejsc     Int
  sredni_koszt_dps Float?
  sredni_koszt_sds Float?
  min_koszt        Float?
  max_koszt        Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([wojewodztwo, rok])
  @@index([wojewodztwo])
  @@index([rok])
}

model AdminSecurityLog {
  id        Int      @id @default(autoincrement())
  eventType String
  ipAddress String?
  userAgent String?
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([eventType])
  @@index([timestamp])
  @@index([ipAddress])
}

model PartnerInquiry {
  id            Int      @id @default(autoincrement())
  name          String
  email         String
  organization  String
  partnerType   String   // 'mops' | 'facility' | 'association' | 'other'
  phone         String?
  message       String   @db.Text
  gdprConsent   Boolean
  status        String   @default("new")  // 'new' | 'contacted' | 'completed' | 'archived'
  notes         String?  @db.Text
  adminUser     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email, createdAt])
  @@map("partner_inquiries")
}

model PlacowkaCena {
  id              Int       @id @default(autoincrement())
  placowkaId      Int
  rok             Int       // 2024, 2025, 2026
  kwota           Float
  typ_kosztu      String    @default("podstawowy") // "podstawowy" | "maksymalny"
  zrodlo          String?   // URL do dokumentu MOPS
  data_pobrania   DateTime  @default(now())
  data_obowiazuje DateTime? // Od kiedy obowiązuje ta cena
  verified        Boolean   @default(false)
  notatki         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  placowka        Placowka  @relation("PlacowkaCeny", fields: [placowkaId], references: [id], onDelete: Cascade)

  @@unique([placowkaId, rok, typ_kosztu])
  @@index([placowkaId])
  @@index([rok])
  @@index([placowkaId, rok])
}
